提案手法

\subsection{文対応}

文対応推定のための提案手法を説明する前に，本論文で扱う文対応について改めて定義する．本研究では，「文書（往信文書）とそれに対する返信文書が与えられた時，ある返信文がある往信文を原因として生起している関係」を\textbf{文対応}と定義し，この関係の有無を推定することを目的とする．なお，文対応は返信文書中の1文から，往信文書中の複数の文へ対応することを許す．また，返信文書中の異なる文から，往信文書中の同一の文への対応も許す．

例えば図 \ref{fig:ex-dependency} の「講義を楽しんでいただけて何よりです。」という返信文は，「本日の講義も楽しく拝聴させて頂きました。」という往信文を原因として書かれた文であるため，文対応を持つ．同様に，返信文「まず、課題提出日ですが…」「失礼しました。」はいずれも往信文「また、課題提出日が…」を原因として書かれた文であるため，両方の対とも文対応を持つ．

なお，我々が扱う文対応関係と Qu \& Liu \citeyear{Zhonghua2012} が扱う文依存関係 (sentence dependency) とは次の点で異なる．すなわち，我々の扱う文対応は返信文から往信文へ向かう一方向のみであるが，彼らの扱う文依存関係は任意の対話文から対話文への関係を持ちうる\footnote{ただし，ほぼ全ての文依存関係は後に出現する文から前に出現した文へ向かう方向であると予想できる．Qu \& Liu が論文中で示す例に登場する文依存関係も，後の文から前の文へ向かう関係のみであった \cite{Zhonghua2012}．}．以降，本論文では Qu \& Liu が扱う対応関係を\textbf{文依存関係}と呼び，我々が扱う文対応関係と区別する．


\subsection{文種類}

次に，文対応推定に用いる素性の一つである文種類についても説明する．本研究では，「ある文がどのような目的で書かれているかによる分類」を\textbf{文種類}と定義する．

どのような文種類の集合を用いるかは対象とする文書によって異なるが，例えば図 \ref{fig:ex-dependency} のようなメール文書対を対象とする場合は「挨拶」「質問」「謝罪」「回答」などが文種類として考えられる．一方，質問応答ウェブサイトを対象とした Qu \& Liu は，「質問」「回答」「挨拶」など，13種類の文種類を定義している \cite{Zhonghua2012}．本研究の実験では，対象をレビュー文書とその応答文書としているため，これらの文書における文種類の分類を行っている大沢らの先行研究 \cite{大沢:2010} を元にして文種類を定義した．具体的な変更点と文種類については評価実験の章（4章）で議論する．


\subsection{因子グラフと CRF} \label{sec:factor-graph}

以降の節では，各 CRF モデルの説明に Kschischang らが提案した因子グラフ (factor graph) を用いる \cite{Kschischang2001}．そのため，ここで因子グラフについて Sutton \& McCallum (2012) の解説を参考にして簡単に説明する．

因子グラフは，ある複数の変数に依存する関数を一部の変数のみに依存する複数の関数（因子）の積に分解した際に，どのような分解が行われているかを表現する二部グラフである．因子グラフでは，因子が依存する変数を正方形の因子ノード ■ からのリンクによって表す．また，変数のうち観測変数と隠れ変数を区別する必要がある場合は，観測変数を灰色（色付き）ノード，隠れ変数を白色（無色）ノードで表す．

\begin{figure}[b]
\begin{center}
\includegraphics{22-1ia2f3.eps}
\end{center}
\hangcaption{因子グラフの例．対数線形モデルにより $P(\bm{y}|\bm{x})$ をモデル化した場合の Linear-chain CRF に相当する．}
\label{fig:L-CRF}
\end{figure}

実際の因子グラフの例を図 \ref{fig:L-CRF} に示す．図 \ref{fig:L-CRF} は，観測変数 $\bm{x}$，隠れ変数 $\bm{y}$ を引数に持つようなある関数 $F(\bm{x},\bm{y})$ を次のように因数分解することを示している．
\begin{equation}
  F(\bm{x},\bm{y}) = \prod_{i=1}^{|\bm{y}|} f_i(\bm{x},y_i) \cdot \prod_{j=1}^{|\bm{y}|-1} g_i(\bm{x},y_{j},y_{j+1})
\end{equation}

以降，因子グラフを数式で表現するために，因子グラフ $\mathcal{G}$ を，変数ノードの集合 $\mathcal{V}$・因子ノードの集合 $\mathcal{F}$・エッジの集合 $\mathcal{E}$ の3つを用いて $\mathcal{G} = (\mathcal{V},\mathcal{F},\mathcal{E})$ のように表現する．なお，集合の表記を簡便にするため次のような記法を導入する．例えば，$\{ y_i \}_{i=1}^{5}$ のように書いた場合，これは $\{ y_i ~|~ 1 \leq i \leq 5 \wedge i \in \mathbb{N} \} = \{ y_1, \dots, y_5 \}$ を意味する．この記法を用いれば，図 \ref{fig:L-CRF} の因子グラフを $\mathcal{G} = (\mathcal{V},\mathcal{F},\mathcal{E})$  とすると $\mathcal{V},\mathcal{F},\mathcal{E}$ は次のように表現できる．
\begin{equation}
\begin{split}
  \mathcal{V} &= \{ \bm{x} \} \cup \{ y_i \}_{i=1}^{5} \\ 
  \mathcal{F} &= \{ f_i \}_{i=1}^{5} \cup \{ g_j \}_{j=1}^{4} \\ 
  \mathcal{E} &= \{ (f_i, \bm{x}) \}_{i=1}^{5} \cup \{ (f_i, y_i) \}_{i=1}^{5} \cup \{ (g_j, \bm{x}) \}_{j=1}^{4} \cup \{ (g_j, y_j) \}_{j=1}^{4} \cup \{ (g_j, y_{j+1}) \}_{j=1}^{4}
\end{split}
\end{equation}

次に，因子グラフに基づいた CRF モデルを構築する方法について説明する．因子グラフ自体は因子が具体的にどのような関数であるかを規定しないが，関数 $F$ を対数線形モデルによりモデル化した $P(\bm{y}|\bm{x})$ とすると，因子グラフに基づいた CRF モデルが構築できる．具体的に，因子を $\Psi_a$，因子 $\Psi_a$ が依存する変数を $\bm{x}_a, \bm{y}_a$ と置くと $P(\bm{y}|\bm{x})$ は次のようにモデル化される．
\begin{align}
  P(\bm{y}|\bm{x}; \bm{\theta}) & = \frac{1}{Z} \prod_a \Psi_a (\bm{x}_a, \bm{y}_a; \bm{\theta}_a) \\
                   & = \frac{1}{Z} \prod_a \exp \left\{ \sum_k \theta_{ak} f_{ak} (\bm{x}_a, \bm{y}_a) \right\}
\end{align}
ここで $Z$ は正規化項，$\theta_{ak}$ は素性関数 $f_{ak}$ に対応した重みとなる．なお，同様のモデル化を図~\ref{fig:L-CRF} に行った場合が Linear-chain CRF に相当する．

本論文では，各モデルは CRF によってモデル化されることとする．各モデルの因子と変数間の依存関係については，それぞれ元となる因子グラフによって示す．


\subsection{文対応推定手法の概要}

本論文で提案する文対応推定手法は，Qu \& Liu が提案した文依存関係推定手法 \cite{Zhonghua2012} を我々の課題に併せて変形を加えた手法と，彼らの推定モデルを発展させた新たな推定モデルによる手法の二種類である．ここで最初に，彼らの手法の概要と我々が提案する手法との相違点について説明する．

Qu \& Liu の手法では，文依存関係を推定する問題を系列ラベリング問題と考え，Linear-chain CRF 又は 2D CRF を用いて推定を行う．これは，ある返信文から往信文への依存関係が存在している時，同じ返信文から隣接する往信文へも依存する可能性が高いという傾向，または逆にある往信文へ依存している返信文がある時，隣接する返信文から同じ往信文へも依存する可能性が高いという傾向を活用するためである．また，彼らは特に文依存関係分類器の素性に注目し，文の種類を素性として利用することを提案している．これは，例えば「質問」や「要求」を述べている文は通常「回答」と対応するが「挨拶」とは対応しないなど，文種類が特定できれば文依存関係の推定に有用であるという観察に基づく．ただし，このような文種類が予め分かっている状況は稀であるため，各発話の種類を推定するための分類器を別途作成する．この文種類分類器を利用する手法では，与えられた対話文書に対して事前に文種類分類器を適用して文種類を推定しておき，対話文書と文種類推定結果を文依存関係分類器に入力することで最終的に文依存関係を得る．

我々の課題に合わせて彼らの手法を変形する手法では，文対応推定問題を系列ラベリング問題と考える点や文種類を利用する点で同一である．異なるのは，彼らが文種類推定器を一つしか用意せずにどの発話者による発話文に対しても同じ文種類推定器を用いていたのに対し，我々は往信文書・返信文書のそれぞれに対して別の文種類推定器を用意する点である．これは，往信文書・返信文書ではそれぞれに特有な文種類が存在するなどの異なった傾向が存在するという仮定に基づく．また，彼らが提案する文対応推定モデルは，「返信文が同じで往信文が隣接する対応」の連接性を考慮したモデルと「返信文が同じで往信文が隣接する対応」「往信文が同じで返信文が隣接する対応」双方の連接性を考慮したモデルの二種類であったが，我々は「往信文が同じで返信文が隣接する対応」のみの連接性を考慮したモデルについても検討を加える点でも異なる．

また，彼らの手法と我々が新たに提案する推定モデルによる手法の違いは，彼らが文種類・文依存関係推定モデルを別々に用意して文種類推定・文依存関係推定の二段階の手順を踏むのに対し，我々は文種類・文対応推定モデルを統合した一つのモデルで一度に推定する点である．

以降，\ref{sec:qu-liu}節で Qu \& Liu の推定モデルについて説明し，\ref{sec:proposal-simple}節以降で提案手法について順次説明する．


\subsection{Qu \& Liu による文依存関係推定手法の概要} \label{sec:qu-liu}

Qu \& Liu が提案した対話文書における文依存関係を推定する手法 \cite{Zhonghua2012} では，文種類推定器と文依存関係分類器の二種類を用意する．そこで，最初に文種類推定器について説明し，次に文依存関係分類器について説明する．ここで，説明のために以下の記号を導入する．

\vspace{0.25zh}
\begin{tabular}{rl}
$N$                    & 対話文の文数 \\
$\bm{x}$               & 対話文の列 $x_1, x_2, \dots x_N$ \\
$\bm{t}$               & 対話文の種類の列 $t_1, t_2, \dots t_N$ \\
$y_{i,j}$              & 対話文 $x_i$ から $x_j$ への文依存関係の存在有無（二値） \\
$\bm{y}$               & 全ての文依存関係 $y_{i,j}$ からなる集合 $\{ y_{i,j} ~|~ 1 \leq i \leq N,~ 1 \leq j \leq N \}$ \\
\end{tabular}
\vspace{0.25zh}

\noindent
ここで，$y_{i,j}$ は対話文 $x_i$ から $x_j$ の間に文依存関係が存在すれば1，しなければ0の二値を取る変数である\footnote{なお，Qu \& Liu は同じ文への依存関係 ($i=j$) に関して特に触れていないが \cite{Zhonghua2012}，同じ文への依存関係はないものと考えられる．}．

各文の種類を推定する問題は，文 $\bm{x}$ を観測変数，文種類 $\bm{t}$ を隠れ変数と考えると，系列ラベリング問題とみなすことができる．そこで，彼らは Linear-chain CRF \cite{Lafferty2001} を利用することで文種類推定器を実現する．

各文間の文対応を推定する問題も，文 $\bm{x}$ を観測変数，文依存関係 $\bm{y}$ を隠れ変数としたラベリング問題と考えることができる．ここで，予め文種類推定器により推定した文種類 $\hat{\bm{t}}$ を素性の一つに投入することで，文種類を考慮した文依存関係の推定を実現する．ただし，文依存関係 $\bm{y}$ は文種類系列とは異なり二次元の構造を持つため，このままでは一次元の系列を対象とする Linear-chain CRF を用いることはできない．そこで，彼らは二次元構造の行ごとに順次推定を行うことで Linear-chain CRF を適用する手法と，二次元構造を一度に推定できる 2D CRF \cite{Zhu2005} を適用する手法を提案している．

\begin{figure}[b]
\begin{center}
\includegraphics{22-1ia2f4.eps}
\end{center}
\caption{Linear-chain CRF により文依存関係を推定する手順．k は注目している文の位置を示す．}
\label{fig:L-CRFc}
\end{figure}

Linear-chain CRF を繰り返し適用して文依存関係を推定する過程を図 \ref{fig:L-CRFc} に示す．まず最初に注目する文 $x_k ~ (1 \leq k \leq N)$ を固定し，$x_k$ から全ての $x_1, x_2, \dots x_N$ への文依存関係 $y_{k,\Circle[f]} ~ (1 \leq \Circle[f] \leq N)$ について考える．これにより，$y_{k,\Circle[f]}$ は一次元の系列となるため，Linear-chain CRF を適用可能になる．この処理を全ての $x_k$ に対して繰り返し適用することで，$\bm{y}$ 全体の推定が実現する．この Linear-chain CRF においては連接確率 $P(y_{i,j}|y_{i,j-1},\bm{x})$ が考慮されることになる．これにより，依存元が同じで依存先が隣接する $y_{i,j}, y_{i,j-1}$ の片方が依存関係にあればもう片方にも依存関係が存在することが多い傾向を活用できる\footnote{この場合とは逆に，依存先が同じで依存元が隣接する $y_{i,j}, y_{i-1,j}$ の連接性についても，Linear-chain CRF を $y_{\Circle[f],j}$ に順次適用することで考慮でき結果として全体の推定が実現するが，Qu \& Liu はこの場合については検討を行っていない \cite{Zhonghua2012}．本論文が対象とする文対応推定の際には，この場合に相当する文対応推定器も作成して性能の比較検討を行う．}．

これに対し，2D CRF を適用して推定する手法では $\bm{y}$ 全体を一度に推定できる．ここで 2D CRF について，2D CRF を因子グラフで表現した図 \ref{fig:2D-CRFc}を用いて説明する．Linear-chain CRF を繰り返し適用する手法は，図 \ref{fig:2D-CRFc} の因子のうち各 $y$ を横方向 $y_{i,j}, y_{i,j-1}$ を結ぶ因子のみを残した場合に相当し，各行 $y_{i,\Circle[f]}$ ごとに推定を行う．一方 2D CRF では，各 $y$ を縦方向 $y_{i,j}, y_{i-1,j}$ に結ぶ因子が加わる．これにより，Linear-chain CRF では依存元が同じで依存先が隣接する $y_{i,j}, y_{i,j-1}$ の連接性のみを考慮していたが，依存先が同じで依存元が隣接する $y_{i-1,j}, y_{i,j}$ についての連接性も同時に考慮されるようになる．

\begin{figure}[t]
\begin{center}
\includegraphics{22-1ia2f5.eps}
\end{center}
\hangcaption{2D CRF の因子グラフ（$\bm{y}$ が $3 \times 3$ の場合の例．$\bm{x}$ からすべての各因子へはリンクが接続されるが，図が煩雑になるため描画を省略した）．実線は隣接する $y_{i,j}$ 同士を結ぶ因子に関わる変数に，点線は一つの $y_{i,j}$ を直接結ぶ因子に関わる変数に接続している．}
\label{fig:2D-CRFc}
\end{figure}

Qu \& Liu によると，2D CRF による文依存推定モデルの方が Linear-chain CRF を繰り返し適用する推定モデルよりも性能が向上したことを報告している．


\subsection{文種類・文依存関係推定モデルの本問題への適用} \label{sec:proposal-simple}

次に，以上に述べた Qu \& Liu による文依存関係推定モデル \cite{Zhonghua2012} を，本論文の目的である二文書間の文対応推定へ適用する提案手法について説明する．本提案手法も彼らと同じく文種類推定器・文対応推定器の二種類を用意して順次推定する手法であり，以下でそれぞれについて順に説明する．ここで，説明のために以下の記号を改めて導入する．

\vspace{0.25zh}
\begin{tabular}{rl}
$N$                    & 往信文の文数 \\
$M$                    & 返信文の文数 \\
$\bm{x}^{\rm org}$     & 往信文の列 ${x^{\rm o}}_1, {x^{\rm o}}_2, \dots, {x^{\rm o}}_N$ \\
$\bm{x}^{\rm rep}$     & 返信文の列 ${x^{\rm r}}_1, {x^{\rm r}}_2, \dots, {x^{\rm r}}_M$ \\
$\bm{t}^{\rm org}$     & 各往信文の種類の列 ${t^{\rm o}}_1, {t^{\rm o}}_2, \dots, {t^{\rm o}}_N$ \\
$\bm{t}^{\rm rep}$     & 各返信文の種類の列 ${t^{\rm r}}_1, {t^{\rm r}}_2, \dots, {t^{\rm r}}_M$ \\
$y_{i,j}$              & 往信文 ${x^{\rm o}}_i$ と返信文 ${x^{\rm r}}_j$ の間における文対応存在の有無（二値） \\
$\bm{y}$               & 全ての文対応 $y_{i,j}$ からなる集合 $\{ y_{i,j} ~|~ 1 \leq i \leq N,~ 1 \leq j \leq M \}$ \\
\end{tabular}
\vspace{0.25zh}

\noindent
ここで，$y_{i,j}$ は往信文 ${x^{\rm o}}_i$ から返信文 ${x^{\rm r}}_j$ の間に文対応関係が存在すれば1，しなければ0の二値を取る変数である．

各文の種類を推定する問題は，文 $\bm{x}^{\rm org}$（又は $\bm{x}^{\rm rep}$）を観測変数，文種類 $\bm{t}^{\rm org}$（又は $\bm{t}^{\rm rep}$）を隠れ変数とした系列ラベリング問題と考えることができる．ここで，我々は往信文書・返信文書ではそれぞれに特有な文種類が存在し，それぞれの文書で文種類の連接について異なった傾向があると予想した．例えば，一般に往信文書は人に向けて文書を新たに発信する動機である「質問」や「要望」が含まれる可能性が高いのに対し，返信文書はそれに対する「回答」が含まれる可能性が高い．そこで，我々は Qu \& Liu とは異なり，文種類分類器を往信文書用・返信文書用に別々に用意することにした．なお，いずれの分類器についても Linear-chain CRF \cite{Lafferty2001} を利用する．以降，これらのモデルをそれぞれ往信文種類モデル・返信文種類モデルと呼ぶ．

各文間の文対応を推定する問題は，二文書 $\bm{x}^{\rm org}, \bm{x}^{\rm rep}$ を観測変数，文対応 $\bm{y}$ を隠れ変数と考えることができる\footnote{ただし，Qu \& Liu が扱う文依存関係とは，往信文同士の間や返信文同士の間についての関係については考えない点，文対応は一方向の関係である点で異なる．前者については，文依存関係に対して「発話者が異なる文間のみ」という制約を陽に加えた場合とみなすこともできる．}．本提案手法でも文種類分類器により推定した $\hat{\bm{t}}^{\rm org}, \hat{\bm{t}}^{\rm rep}$ を素性の一つに投入し，文種類を考慮した文対応の推定を実現する．以下，前節と同様に Linear-chain CRF を繰り返し適用する手法と，2D CRF を適用する手法について順次説明する．

文対応の推定では，注目する文を固定すれば Linear-chain CRF を繰り返し適用することで文対応 $\bm{y}$ 全体の推定が可能である．ここで，往信文 ${x^{\rm o}}_i$ と返信文 ${x^{\rm r}}_j$ のどちらを固定し，どちらの文対応連接性に注目するかで異なった分類器を作成することができる．これに対し，往信文間における対応の連接性を考慮する（返信文を固定し，$y_{\Circle[f],j}$ を順次推定する）手法を L-CRF$_{\rm{org}}$，返信文間における対応の連接性を考慮する（往信文を固定し，$y_{i,\Circle[f]}$ を順次推定する）手法を L-CRF$_{\rm{rep}}$ とする．それぞれの手法の推定過程を図 \ref{fig:L-CRFinitproc}, \ref{fig:L-CRFrepproc} に示す．なお，Qu \& Liu が Linear-chain CRF を文依存関係推定に用いた場合が，本手法の L-CRF$_{\rm{org}}$ と対応している．

\begin{figure}[t]
\begin{minipage}{0.49\hsize}
\begin{center}
\includegraphics{22-1ia2f6.eps}
\end{center}
\caption{L-CRF$_{\rm{org}}$ での文対応推定手順}
\label{fig:L-CRFinitproc}
\end{minipage}
\begin{minipage}{0.49\hsize}
\begin{center}
\includegraphics{22-1ia2f7.eps}
\end{center}
\caption{L-CRF$_{\rm{rep}}$ での文対応推定手順}
\label{fig:L-CRFrepproc}
\end{minipage}
\end{figure}

また，2D CRF を用いた文対応の推定も可能である．この場合，Qu \& Liu の場合とほぼ同様に推定が可能である．このモデルは，往信文間・返信文間それぞれにおける対応の連接性を同時に考慮できるという特徴を持っている．


\subsection{文種類・文依存関係推定モデルの統合} \label{sec:proposal-combine}

以上までに説明した提案手法は Qu \& Liu の手法と同様，最初に推定した文種類情報を文対応推定の素性として用いる．しかし，文種類を全て正しく推定することは困難であり，推定した文種類情報にはいくらかの誤りが含まれる可能性が高い．そのため，文種類推定時の誤りはそのまま文対応推定に影響を与える．そこで，我々は文種類と文対応を推定するモデルを統合し，両者を同時に推定することで文対応推定誤りの影響の抑制を狙った統合モデルを提案する．

本論文では統合の元となるモデルとして，文種類推定に Linear-chain CRF を用いた往信文種類モデル・返信文種類モデル，文対応推定に 2D CRF を用いた文対応モデルを考える．これらのモデルに対し，文種類変数と文対応変数に依存する因子関数を新たに加えることで，統合モデルを実現する．以下，具体的な統合方法について因子グラフを用いながら説明する．

まず最初に，統合の元となる各モデルの因子グラフを図 \ref{fig:model-before} に示す．ここで，各モデルの因子グラフ構造を \ref{sec:factor-graph} 節の記法を用いて記述すると，以下の通りである．
\vspace{1\Cvs}

\begin{figure}[b]
\begin{center}
\includegraphics{22-1ia2f8.eps}
\end{center}
\hangcaption{統合前のモデル（往信文・返信文が共に2文の場合．$\bm{x}$ から各因子への接続は省略している）．左から順に，往信文種類モデル，文対応モデル (2D CRF)，返信文種類モデル．}
\label{fig:model-before}
\end{figure}

\begin{description}
\item[往信文種類モデル] \mbox{} \\
  Linear-chain CRF により往信文種類を推定する．観測変数は往信文 $\bm{x}^{\rm org}$，隠れ変数は往信文種類 $\bm{t}^{\rm org}$ である．観測変数と隠れ変数を結ぶ因子を ${f^o}_i$，隠れ変数同士を結ぶ因子を ${g^o}_j$ とする ($1 \leq i \leq N,~ 1 \leq j \leq N-1$)．
  モデルの因子グラフを $\mathcal{G}_{\rm otype} = \{ \mathcal{V}_{\rm otype}, \mathcal{F}_{\rm otype}, \mathcal{E}_{\rm otype} \}$ とすると，$\mathcal{V}_{\rm otype}, \mathcal{F}_{\rm otype}, \mathcal{E}_{\rm otype}$ はそれぞれ以下の通りである．因子グラフを図 \ref{fig:model-before}（左）に示す．
\begin{equation}
 \begin{split}
  \mathcal{V}_{\rm otype} &= \{ \bm{x}^{\rm org}\} \cup \{ {t^o}_i \}_{i=1}^{N}  \\
  \mathcal{F}_{\rm otype} &= \{ {f^o}_i \}_{i=1}^{N} \cup \{ {g^o}_j \}_{j=1}^{N-1}  \\
  \mathcal{E}_{\rm otype} &= \{ ({f^o}_i, \bm{x}^{\rm org}) \}_{i=1}^{N} \cup \{ ({f^o}_i, {t^o}_i) \}_{i=1}^{N} \\
    & \qquad \cup \{ ({g^o}_j, {\bm{x}^{\rm org}}) \}_{j=1}^{N-1} 
	\cup \{ ({g^o}_j, {t^o}_j) \}_{j=1}^{N-1} \cup \{ ({g^o}_j, {t^o}_{j+1}) \}_{j=1}^{N-1}
 \end{split}
\end{equation}
  
\item[返信文種類モデル] \mbox{} \\
  Linear-chain CRF により返信文種類を推定する．観測変数は往信文 $\bm{x}^{\rm rep}$，隠れ変数は往信文種類 $\bm{t}^{\rm rep}$ である．観測変数と隠れ変数を結ぶ因子を ${f^r}_i$，隠れ変数同士を結ぶ因子を ${g^r}_j$ とする ($1 \leq i \leq M,~ 1 \leq j \leq M-1$)．
  モデルの因子グラフを $\mathcal{G}_{\rm rtype} = \{ \mathcal{V}_{\rm rtype}, \mathcal{F}_{\rm rtype}, \mathcal{E}_{\rm rtype} \}$ とすると，$\mathcal{V}_{\rm rtype}, \mathcal{F}_{\rm rtype}, \mathcal{E}_{\rm rtype}$ はそれぞれ以下の通りである．因子グラフを図 \ref{fig:model-before}（右）に示す．
\begin{equation}
 \begin{split}
  \mathcal{V}_{\rm rtype} &= \{ \bm{x}^{\rm rep} \} \cup \{ {t^r}_i \}_{i=1}^{M}  \\
  \mathcal{F}_{\rm rtype} &= \{ {f^r}_i \}_{i=1}^{M} \cup \{ {g^r}_j \}_{j=1}^{M-1}  \\
  \mathcal{E}_{\rm rtype} &= \{ ({f^r}_i, \bm{x}^{\rm rep}) \}_{i=1}^{M} \cup \{ ({f^r}_i, {t^r}_i) \}_{i=1}^{M} \\
     & \qquad \cup \{ ({g^r}_j, {\bm{x}^{\rm rep}}) \}_{j=1}^{M-1} \cup \{ ({g^r}_j, {t^r}_j) \}_{j=1}^{M-1} 
	\cup \{ ({g^r}_j, {t^r}_{j+1}) \}_{j=1}^{M-1}
 \end{split}
\end{equation}

\item[文対応モデル] \mbox{} \\
  2D CRF により文対応を推定する．観測変数は往信文 $\bm{x}^{\rm org}$ 及び返信文 $\bm{x}^{\rm rep}$（これらをまとめて $\bm{x}$ とする），隠れ変数は文対応 $\bm{y}$ である．観測変数と隠れ変数を結ぶ因子を $f_{i,j}$，隠れ変数同士を結ぶ因子のうち，往信文を固定して隣接する返信文への対応間を考慮する（$y_{i,j}$ を横に結ぶ）因子を $g_{k,l}$，返信文を固定して隣接する往信文からの対応間を考慮する（$y_{i,j}$ を縦に結ぶ）因子を $h_{k,l}$ とする ($1 \leq i \leq N,~ 1 \leq j \leq M,~ 1 \leq k \leq N-1,~ 1 \leq l \leq M-1$)．因子グラフを図 \ref{fig:model-before}（中央）に示す．

モデルの因子グラフを $\mathcal{G}_{\rm relation} = \{ \mathcal{V}_{\rm relation}, \mathcal{F}_{\rm relation}, \mathcal{E}_{\rm relation} \}$ とすると，\\ $\mathcal{V}_{\rm relation}, \mathcal{F}_{\rm relation}, \mathcal{E}_{\rm relation}$ はそれぞれ以下の通りである．
\begin{equation}
\begin{split}
\mathcal{V}_{\rm relation} &= \{ \bm{x} \} \cup \{ {y}_{i,j} \}_{i=1,j=1}^{i=N,j=M} \\
\mathcal{F}_{\rm relation} &= \{ {f}_{i,j} \}_{i=1,j=1}^{i=N,j=M} \cup \{ {g}_{k,l} \}_{k=1,l=1}^{k=N-1,l=M-1} 
	\cup \{ {h}_{k,l} \}_{k=1,l=1}^{k=N-1,l=M-1} \\
\mathcal{E}_{\rm relation} &= \{ ({f}_{i,j}, \bm{x}) \}_{i=1,j=1}^{i=N,j=M} \cup \{ ({f}_{i,j}, y_{i,j}) \}_{i=1,j=1}^{i=N,j=M} \\
  & \qquad \cup \{ ({g}_{k,l}, \bm{x}) \}_{k=1,l=1}^{k=N-1,l=M-1} 
	\cup \{ ({h}_{k,l}, \bm{x}) \}_{k=1,l=1}^{k=N-1,l=M-1} \\
  & \qquad \cup \{ ({g}_{k,l}, {y}_{k,l}) \}_{k=1,l=1}^{k=N-1,l=M-1} \cup \{ ({g}_{k,l}, {y}_{k,l+1}) \}_{k=1,l=1}^{k=N-1,l=M-1} \\
  & \qquad \cup \{ ({h}_{k,l}, {y}_{k,l}) \}_{k=1,l=1}^{k=N-1,l=M-1} \cup \{ ({h}_{k,l}, {y}_{k+1,l}) \}_{k=1,l=1}^{k=N-1,l=M-1}
 \end{split}
\end{equation}
\end{description}

次に，以上の3モデルを統合した新たな提案モデルについて説明する．このモデルでは，文種類・文対応推定を同一のモデルで扱うために，新たに二文の文種類変数と，それと対応する文対応変数に依存する因子関数 $F_{i,j} ~ (1 \leq i \leq N,~ 1 \leq j \leq M)$ を新たに加える．これにより，往信文 ${x^{\rm o}}_{i}$ と返信文 ${x^{\rm r}}_{j}$ に対応する往信文種類 ${t^{\rm o}}_{i}$・返信文種類 ${t^{\rm r}}_{j}$・文対応 $y_{i,j}$ が非独立的に扱われるようになり，文種類・文対応を同時に推定を行うことが可能になる．提案手法全体のグラフ構造を図 \ref{fig:model-after} に示す．因子グラフ構造を具体的な式で記述すると，以下の通りである．以下，必要に応じて統合したモデルを combine と呼ぶ．
\vspace{1\Cvs}

\begin{figure}[t]
\begin{center}
\includegraphics{22-1ia2f9.eps}
\end{center}
\hangcaption{統合後のモデル（combine; 往信文・返信文が共に2文の場合．$\bm{x}$ から各因子への接続は省略している）．実線は新たに加えた因子を結ぶリンク．}
\label{fig:model-after}
\end{figure}

\begin{description}
\item[統合モデル (combine)] \mbox{} \\
   観測変数は往信文 $\bm{x}^{\rm org}$ 及び返信文 $\bm{x}^{\rm rep}$（これらをまとめて $\bm{x}$ とする），隠れ変数は往信文種類 ${\bm{t}^{\rm org}}$・返信文種類 ${\bm{t}^{\rm rep}}$・文対応 $\bm{y}$ である．新たに導入する因子を $F_{i,j}$ とする  ($1 \leq i \leq N,~ 1 \leq j \leq M$)．その他の因子は統合前の各モデルと同様である．

  モデルの因子グラフを $\mathcal{G}_{\rm combine} = \{ \mathcal{V}_{\rm combine}, \mathcal{F}_{\rm combine}, \mathcal{E}_{\rm combine} \}$ とすると，\\ $\mathcal{V}_{\rm combine}, \mathcal{F}_{\rm combine}, \mathcal{E}_{\rm combine}$ はそれぞれ以下の通りである（新たに加わった因子に関わる部分を下線によって強調している）．因子グラフを図 \ref{fig:model-after} に示す．
\begin{equation}
 \begin{split}
  \mathcal{V}_{\rm combine} &= \{ \bm{x} \} \cup \{ {t^o}_i \}_{i=1}^{N} \cup \{ {t^r}_i \}_{j=1}^{M} \cup\{ {y}_{i,j} \}_{i=1,j=1}^{i=N,j=M} \\
  \mathcal{F}_{\rm combine} &= \mathcal{F}_{\rm otype} \cup \mathcal{F}_{\rm rtype} 
	\cup \mathcal{F}_{\rm relation} \cup \underline{\{ {F}_{i,j} \}_{i=1,j=1}^{i=N,j=M}} \\
  \mathcal{E}_{\rm combine} &= \mathcal{E}_{\rm otype} \cup \mathcal{E}_{\rm rtype} \cup \mathcal{E}_{\rm relation} \\
   & \qquad \cup \underline{\{ ({F}_{i,j}, \bm{x}) \}_{i=1,j=1}^{i=N,j=M} \cup \{ ({F}_{i,j}, {t^{\rm o}}_{i}) \}_{i=1,j=1}^{i=N,j=M} 
	\cup \{ ({F}_{i,j}, {t^{\rm o}}_{j}) \}_{i=1,j=1}^{i=N,j=M}}
 \end{split}
\end{equation}
\end{description}

なお，Linear-chain CRF などでは各隠れ変数の周辺確率 $P(y|\mathbf{x})$ を Forward-Backward アルゴリズムにより効率的に求めることができるが，統合モデルのように閉路を含む因子グラフ上の CRF には適用することができない．そのため，Tree Based reParameterization (TRP) \cite{Wainwright2001b} などにより近似的に求める必要がある．


